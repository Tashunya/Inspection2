{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Boiler Page {% endblock %}

{% block page_content %}
<div class="page-header">
    <h3> <a href=" {{ url_for('main.company', id=boiler.company_id) }} "> {{ company.company_name }} </a></h3>
    <h1>Boiler {{ boiler.boiler_name }} </h1>
    <p>
    {% if current_user.can(Permission.CREATE_BOILER) %}
    <a class="btn btn-danger btn-xs"
    href=" {{ url_for('boiler.edit_boiler', id=boiler.id) }}">
        Edit Boiler
    </a>
    {% endif %}
</p>
</div>

<!-- CHOOSE BOILER ELEMENT -->

<div class="col-md-4">
    {{ wtf.quick_form(form) }}
    <input id="chooseNode" type="submit" class="btn btn-info btn-sm" value="Choose element">
</div>


<script>
    $( function() {
        $('#block').change( function() {
            $.get("/boiler/children/" + this.value, success, "json");
        });

        function success(childrenArray) {
        $("select[id='level_1']").find("option").remove();
        $("select[id='level_2']").find("option").remove()
        var levelOneOptions = "<option selected value='__None'></option>";
        for(var i = 0; i < childrenArray.length; i++) {
            levelOneOptions += "<option value='" + childrenArray[i].id + "'>" + childrenArray[i].node_name + "</option>";
        }
        $("select[id='level_1']").append(levelOneOptions);
        };
     });
</script>

<script>
    $( function() {
        $('#level_1').change( function() {
            $.get("/boiler/children/" + this.value, success, "json");
        });

        function success(childrenArray) {
        $("select[id='level_2']").find("option").remove();
        var levelOneOptions = "<option selected value='__None'></option>"
        for(var i = 0; i < childrenArray.length; i++) {
            levelOneOptions += "<option value='" + childrenArray[i].id + "'>" + childrenArray[i].node_name + "</option>";
        }
        $("select[id='level_2']").append(levelOneOptions);
        };
     });
</script>

<div class="col-md-12">
    <h3>Measurements</h3>

<!--  ELEMENT NAME   -->

<h3><div id="elementName"> </div></h3>


<!--  BUTTON GROUP WITH YEARS  -->

<div class="btn-group btn-group-sm" role="group" aria-label="year">
</div>

<!--  RESULTS IN TABLE  -->

<table class="table table-bordered table-hover">
    <thead class="thead-dark">
        <th scope="col">#</th>
        <th scope="col">Point Index</th>
        <th scope="col">Value</th>
        <th scope="col">Origin</th>
        <th scope="col">Minor</th>
        <th scope="col">Major</th>
        <th scope="col">Defect</th>
    </thead>
    <tbody>
    </tbody>
</table>
</div>


{% endblock %}

{% block scripts %}

<script>
    $('#chooseNode').click( function() {
        var block = $('#block option:selected').text();
        var level_1 = $('#level_1 option:selected').text();
        var level_2 = $('#level_2 option:selected').text();
        $('#elementName').html(block + '/' + level_1 + '/' + level_2)

        var chosenNode = $('#level_2').val();

        $.get("/boiler/table/" + chosenNode, chooseElement, "json");

        function chooseElement(tableArray) {
            var btnGroup = $(".btn-group");
            btnGroup.find("button").remove();
            var measuresYears = Object.keys(tableArray);
            var lastYear = measuresYears[measuresYears.length-1];

            for(var i = 0; i < measuresYears.length; i++) {
                var button = '<button type="button" class="btn btn-outline-info">' + measuresYears[i] + '</button>'
                btnGroup.append(button);
            };

            var lastYearData = tableArray[lastYear];

            var results = $("tbody");

            results.find("tr").remove();
            lastYearData.forEach(function(element, index) {
                var newRow = '<tr><td>' + (index+1) + '</td><td>'
                var columns = ['node_name','value', 'default', 'minor', 'major', 'defect'];

                columns.forEach(function(column, num) {
                    newRow += element[column] + ((num==columns.length-1) ? '</td></tr>' : '</td><td>')
                });

                results.append(newRow);
            });
        };
    });

</script>

<script>
    $("button.btn").click( function() {
        alert("You clicked: " + this.textContent);
    });
</script>

{% endblock %}
